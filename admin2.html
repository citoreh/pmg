<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>پنل مدیریت بازی - ادمین</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:'Vazirmatn',sans-serif;
            direction:rtl;
            background:linear-gradient(135deg,#0D0D0D 0%,#1A1A1A 50%,#2E3A59 100%);
            min-height:100vh;color:#F5F5F5;padding:20px;
        }
        .container{max-width:1200px;margin:0 auto}
        header{background:rgba(26,26,26,0.8);border-radius:20px;border:2px solid #D4AF37;padding:30px;text-align:center;margin-bottom:30px}
        h1{font-size:2.2rem;background:linear-gradient(45deg,#D4AF37,#B87333);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
        p.lead{color:#A0A0A0}
        .section{background:rgba(26,26,26,0.5);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid rgba(212,175,55,0.25)}
        .login-form{max-width:420px;margin:0 auto;padding:20px;background:rgba(46,58,89,0.2);border-radius:10px}
        label{display:block;margin-bottom:6px;color:#D4AF37;font-weight:700}
        input,select,textarea{width:100%;padding:10px;border-radius:8px;border:2px solid #B87333;background:rgba(26,26,26,0.8);color:#F5F5F5;margin-bottom:10px;font-family:'Vazirmatn'}
        button{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
        .btn-primary{background:linear-gradient(135deg,#D4AF37,#B87333);color:#0D0D0D}
        .btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
        .btn-edit{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:6px 12px;border-radius:8px}
        .btn-success{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#0D0D0D;padding:8px 12px;border-radius:8px}
        .tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
        .tab{padding:8px 14px;border-radius:8px;background:transparent;border:2px solid transparent;color:#A0A0A0;cursor:pointer}
        .tab.active{background:rgba(212,175,55,0.15);border-color:#D4AF37;color:#D4AF37}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .data-table{width:100%;border-collapse:collapse;margin-top:12px}
        .data-table th{background:rgba(212,175,55,0.12);color:#D4AF37;padding:8px;text-align:right;border:1px solid #B87333}
        .data-table td{padding:8px;border:1px solid rgba(184,115,51,0.2);background:rgba(26,26,26,0.2)}
        .action-buttons{display:flex;gap:8px}
        .message{padding:12px;border-radius:8px;margin-bottom:12px;text-align:center}
        .message.success{background:rgba(46,204,113,0.12);border:2px solid #2ecc71;color:#2ecc71}
        .message.error{background:rgba(231,76,60,0.12);border:2px solid #e74c3c;color:#e74c3c}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:999;justify-content:center;align-items:center}
        .modal-content{background:linear-gradient(135deg,#1A1A1A,#2E3A59);border:2px solid #D4AF37;border-radius:12px;padding:18px;width:95%;max-width:600px;max-height:85vh;overflow:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .close-modal{background:transparent;color:#e74c3c;font-size:20px;padding:4px;cursor:pointer;border:none}
        .grid{display:grid;gap:12px}
        @media (min-width:900px){ .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)} }
        @media (max-width:900px){ .tabs{overflow:auto} .data-table th,.data-table td{font-size:0.9rem} }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎮 پنل مدیریت بازی</h1>
            <p class="lead">مدیریت بازیکنان، مراحل، سوالات، آیتم‌ها و موزیک</p>
        </header>

        <!-- Login -->
        <div id="loginSection" class="section">
            <div class="login-form">
                <h2 style="text-align:center;margin-bottom:14px">ورود ادمین</h2>
                <div class="form-group">
                    <label for="loginEmail">ایمیل</label>
                    <input id="loginEmail" type="email" placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">رمز عبور</label>
                    <input id="loginPassword" type="password" placeholder="••••••••">
                </div>
                <button class="btn-primary" style="width:100%" onclick="login()">ورود</button>
                <div id="loginMessage"></div>
            </div>
        </div>

        <!-- Admin -->
        <div id="adminPanel" style="display:none">
            <div class="section" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
                <h2>داشبورد</h2>
                <div style="display:flex;gap:8px;align-items:center">
                    <div style="text-align:center">
                        <div id="playersCount" style="font-size:1.4rem;color:#D4AF37">0</div>
                        <div style="color:#A0A0A0">بازیکنان</div>
                    </div>
                    <div style="text-align:center">
                        <div id="levelsCount" style="font-size:1.4rem;color:#D4AF37">0</div>
                        <div style="color:#A0A0A0">مراحل</div>
                    </div>
                    <button class="btn-danger" onclick="logout()">خروج</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="players" onclick="switchTab(event)">👤 بازیکنان</div>
                <div class="tab" data-tab="levels" onclick="switchTab(event)">🗺️ مراحل</div>
                <div class="tab" data-tab="questions" onclick="switchTab(event)">❓ سوالات</div>
                <div class="tab" data-tab="items" onclick="switchTab(event)">🧩 آیتم‌ها</div>
                <div class="tab" data-tab="music" onclick="switchTab(event)">🎵 موزیک</div>
                <div class="tab" data-tab="settings" onclick="switchTab(event)">⚙️ تنظیمات</div>
            </div>

            <!-- Players Tab -->
            <div id="playersTab" class="tab-content active">
                <div class="section">
                    <h3>افزودن بازیکن</h3>
                    <div class="grid two">
                        <div>
                            <label>نام بازیکن</label>
                            <input id="playerName" type="text" placeholder="نام بازیکن">
                        </div>
                        <div>
                            <label>ایمیل</label>
                            <input id="playerEmail" type="email" placeholder="player@example.com">
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <label>نمره</label>
                        <input id="playerScore" type="number" placeholder="0">
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addPlayer()">افزودن بازیکن</button>
                        <div id="playerMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>لیست بازیکنان</h3>
                    <div id="playersLoading" class="message" style="background:transparent;color:#D4AF37">در حال بارگذاری...</div>
                    <table id="playersTable" class="data-table" style="display:none">
                        <thead>
                            <tr><th>نام</th><th>ایمیل</th><th>نمره</th><th>عملیات</th></tr>
                        </thead>
                        <tbody id="playersList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Levels Tab -->
            <div id="levelsTab" class="tab-content">
                <div class="section">
                    <h3>افزودن مرحله</h3>
                    <div class="grid two">
                        <div>
                            <label>عنوان مرحله</label>
                            <input id="levelTitle" type="text" placeholder="مثال: مرحله ۱">
                        </div>
                        <div>
                            <label>سختی (1-10)</label>
                            <input id="levelDifficulty" type="number" min="1" max="10" placeholder="1">
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <label>توضیحات</label>
                        <textarea id="levelDesc" rows="3" placeholder="توضیحات مرحله..."></textarea>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addLevel()">افزودن مرحله</button>
                        <div id="levelMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>لیست مراحل</h3>
                    <div id="levelsLoading" class="message" style="background:transparent;color:#D4AF37">در حال بارگذاری...</div>
                    <table id="levelsTable" class="data-table" style="display:none">
                        <thead><tr><th>عنوان</th><th>سختی</th><th>توضیحات</th><th>عملیات</th></tr></thead>
                        <tbody id="levelsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Questions Tab -->
            <div id="questionsTab" class="tab-content">
                <div class="section">
                    <h3>افزودن سوال</h3>
                    <div>
                        <label>متن سوال</label>
                        <textarea id="questionText" rows="2" placeholder="متن سوال..."></textarea>
                    </div>
                    <div class="grid three" style="margin-top:8px">
                        <div><label>گزینه ۱</label><input id="qOpt1" type="text"></div>
                        <div><label>گزینه ۲</label><input id="qOpt2" type="text"></div>
                        <div><label>گزینه ۳</label><input id="qOpt3" type="text"></div>
                    </div>
                    <div class="grid two" style="margin-top:8px">
                        <div>
                            <label>پاسخ صحیح (1/2/3)</label>
                            <input id="qAnswer" type="number" min="1" max="3">
                        </div>
                        <div>
                            <label>متعلق به مرحله (اختیاری)</label>
                            <select id="qLevel"></select>
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addQuestion()">افزودن سوال</button>
                        <div id="questionMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>لیست سوالات</h3>
                    <div id="questionsLoading" class="message" style="background:transparent;color:#D4AF37">در حال بارگذاری...</div>
                    <table id="questionsTable" class="data-table" style="display:none">
                        <thead><tr><th>سوال</th><th>پاسخ</th><th>مرحله</th><th>عملیات</th></tr></thead>
                        <tbody id="questionsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Items Tab -->
            <div id="itemsTab" class="tab-content">
                <div class="section">
                    <h3>افزودن آیتم</h3>
                    <div class="grid two">
                        <div><label>نام آیتم</label><input id="itemName" type="text"></div>
                        <div><label>نوع</label><input id="itemType" type="text" placeholder="مثال: consumable, equip"></div>
                    </div>
                    <div style="margin-top:8px">
                        <label>توضیح</label>
                        <textarea id="itemDesc" rows="2"></textarea>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addItem()">افزودن آیتم</button>
                        <div id="itemMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>لیست آیتم‌ها</h3>
                    <div id="itemsLoading" class="message" style="background:transparent;color:#D4AF37">در حال بارگذاری...</div>
                    <table id="itemsTable" class="data-table" style="display:none">
                        <thead><tr><th>نام</th><th>نوع</th><th>توضیحات</th><th>عملیات</th></tr></thead>
                        <tbody id="itemsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Music Tab -->
            <div id="musicTab" class="tab-content">
                <div class="section">
                    <h3>افزودن موزیک</h3>
                    <div class="grid two">
                        <div><label>عنوان</label><input id="musicTitle" type="text"></div>
                        <div><label>لینک فایل</label><input id="musicUrl" type="url" placeholder="https://...mp3"></div>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addMusic()">افزودن موزیک</button>
                        <div id="musicMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>لیست موزیک</h3>
                    <div id="musicLoading" class="message" style="background:transparent;color:#D4AF37">در حال بارگذاری...</div>
                    <table id="musicTable" class="data-table" style="display:none">
                        <thead><tr><th>عنوان</th><th>لینک</th><th>عملیات</th></tr></thead>
                        <tbody id="musicList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="section">
                    <h3>تنظیمات و پشتیبان‌گیری</h3>
                    <div style="margin-bottom:12px">
                        <label>وضعیت اتصال</label>
                        <p id="connectionStatus" style="color:#2ecc71">✓ متصل به Firebase</p>
                    </div>
                    <div style="margin-bottom:12px">
                        <button class="btn-primary" onclick="exportData()">دانلود داده‌ها (JSON)</button>
                    </div>
                    <div style="margin-bottom:12px">
                        <label>بارگذاری از فایل JSON</label>
                        <input type="file" id="importFile" accept=".json">
                        <div style="margin-top:8px">
                            <button class="btn-primary" onclick="importData()">بارگذاری و جایگزینی</button>
                        </div>
                    </div>
                    <div style="margin-top:12px">
                        <p style="color:#A0A0A0">نکته: هنگام وارد کردن داده‌ها، شناسه‌ها (id) حذف می‌شوند و سندهای جدید ایجاد خواهند شد.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">ویرایش</h3>
                    <button class="close-modal" onclick="closeModal()">✕</button>
                </div>
                <div id="modalBody"></div>
            </div>
        </div>
    </div>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ---------- CONFIG: Replace these with your project's values ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAUUfcl7mEJ3Jw5SiA7dL_0BX4XouZ0kWs",
    authDomain: "shenoto-e26f5.firebaseapp.com",
    projectId: "shenoto-e26f5",
    storageBucket: "shenoto-e26f5.firebasestorage.app",
    messagingSenderId: "276107336693",
    appId: "1:276107336693:web:249f30844ff11b1ef99ebc",
    measurementId: "G-4L3KBNR48S"
  };

        // ---------------------------------------------------------------------

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Local caches
        let players = [], levels = [], questions = [], items = [], music = [];
        let currentUser = null;

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showAdminPanel();
                loadAllData();
            } else {
                currentUser = null;
                showLoginForm();
            }
        });

        // LOGIN / LOGOUT
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showMessage('loginMessage','لطفاً ایمیل و رمز را وارد کنید','error'); return;
            }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('loginMessage','ورود موفق','success');
            } catch (err) {
                console.error(err);
                showMessage('loginMessage','خطا در ورود: ' + (err.message||err),'error');
            }
        }

        async function logout() {
            try {
                await auth.signOut();
            } catch (err) { console.error('Logout error', err); }
        }

        function showAdminPanel(){
            document.getElementById('loginSection').style.display='none';
            document.getElementById('adminPanel').style.display='block';
        }
        function showLoginForm(){
            document.getElementById('loginSection').style.display='block';
            document.getElementById('adminPanel').style.display='none';
        }

        // LOAD all collections
        async function loadAllData(){
            try {
                // Show loading indicators
                document.getElementById('playersLoading').style.display='block';
                document.getElementById('levelsLoading').style.display='block';
                document.getElementById('questionsLoading').style.display='block';
                document.getElementById('itemsLoading').style.display='block';
                document.getElementById('musicLoading').style.display='block';

                // Fetch collections
                const [playersSnap, levelsSnap, questionsSnap, itemsSnap, musicSnap] = await Promise.all([
                    db.collection('players').get(),
                    db.collection('levels').get(),
                    db.collection('questions').get(),
                    db.collection('items').get(),
                    db.collection('music').get()
                ]);

                players = playersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                levels = levelsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                questions = questionsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                items = itemsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                music = musicSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                updateStats();
                renderPlayers();
                renderLevels();
                renderQuestions();
                renderItems();
                renderMusic();
                populateLevelSelects();

            } catch (err) {
                console.error('Error loading data', err);
                showMessage('connectionStatus','خطا در بارگذاری داده‌ها','error');
            } finally {
                // hide loading texts
                ['playersLoading','levelsLoading','questionsLoading','itemsLoading','musicLoading'].forEach(id=>{
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            }
        }

        function updateStats(){
            document.getElementById('playersCount').textContent = players.length;
            document.getElementById('levelsCount').textContent = levels.length;
        }

        // ------------ PLAYERS CRUD ------------
        async function addPlayer(){
            const name = document.getElementById('playerName').value.trim();
            const email = document.getElementById('playerEmail').value.trim();
            const score = Number(document.getElementById('playerScore').value) || 0;
            if (!name) { showMessage('playerMessage','لطفاً نام بازیکن را وارد کنید','error'); return; }
            try {
                await db.collection('players').add({ name, email, score, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('playerMessage','بازیکن اضافه شد','success');
                clearPlayerForm();
                await loadAllData();
            } catch (err) {
                console.error(err); showMessage('playerMessage','خطا در افزودن بازیکن','error');
            }
        }
        function clearPlayerForm(){ ['playerName','playerEmail','playerScore'].forEach(id=>document.getElementById(id).value=''); }

        function renderPlayers(){
            const tbody = document.getElementById('playersList');
            tbody.innerHTML = '';
            players.forEach(p=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(p.name||'-')}</td>
                    <td>${escapeHtml(p.email||'-')}</td>
                    <td>${escapeHtml(p.score==null?0:p.score)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('players','${p.id}')">ویرایش</button>
                            <button class="btn-danger" onclick="deleteDoc('players','${p.id}')">حذف</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('playersTable').style.display = players.length ? 'table' : 'none';
        }

        // ------------ LEVELS CRUD ------------
        async function addLevel(){
            const title = document.getElementById('levelTitle').value.trim();
            const difficulty = Number(document.getElementById('levelDifficulty').value) || 1;
            const desc = document.getElementById('levelDesc').value.trim();
            if (!title) { showMessage('levelMessage','لطفاً عنوان مرحله را وارد کنید','error'); return; }
            try {
                await db.collection('levels').add({ title, difficulty, desc, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('levelMessage','مرحله اضافه شد','success');
                ['levelTitle','levelDifficulty','levelDesc'].forEach(id=>document.getElementById(id).value='');
                await loadAllData();
            } catch (err) { console.error(err); showMessage('levelMessage','خطا در افزودن مرحله','error'); }
        }

        function renderLevels(){
            const tbody = document.getElementById('levelsList'); tbody.innerHTML='';
            levels.forEach(l=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(l.title||'-')}</td>
                    <td>${escapeHtml(l.difficulty||'-')}</td>
                    <td>${escapeHtml(l.desc? (l.desc.length>80? l.desc.substring(0,80)+'...': l.desc) : '-')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('levels','${l.id}')">ویرایش</button>
                            <button class="btn-danger" onclick="deleteDoc('levels','${l.id}')">حذف</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('levelsTable').style.display = levels.length ? 'table' : 'none';
        }

        // ------------ QUESTIONS CRUD ------------
        async function addQuestion(){
            const text = document.getElementById('questionText').value.trim();
            const opt1 = document.getElementById('qOpt1').value.trim();
            const opt2 = document.getElementById('qOpt2').value.trim();
            const opt3 = document.getElementById('qOpt3').value.trim();
            const answer = Number(document.getElementById('qAnswer').value) || 1;
            const levelId = document.getElementById('qLevel').value || null;
            if (!text) { showMessage('questionMessage','لطفاً متن سوال را وارد کنید','error'); return; }
            try {
                await db.collection('questions').add({ text, options:[opt1,opt2,opt3], answer, levelId, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('questionMessage','سوال اضافه شد','success');
                ['questionText','qOpt1','qOpt2','qOpt3','qAnswer'].forEach(id=>document.getElementById(id).value='');
                document.getElementById('qLevel').value='';
                await loadAllData();
            } catch (err){ console.error(err); showMessage('questionMessage','خطا در افزودن سوال','error'); }
        }

        function renderQuestions(){
            const tbody = document.getElementById('questionsList'); tbody.innerHTML='';
            questions.forEach(q=>{
                const levelName = q.levelId ? (levels.find(l=>l.id===q.levelId)?.title || '-') : '-';
                const preview = q.text.length>100 ? q.text.substring(0,100)+'...' : q.text;
                const ansText = (q.options && q.options[q.answer-1]) ? q.options[q.answer-1] : ('گزینه ' + q.answer);
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(preview)}</td>
                    <td>${escapeHtml(ansText)}</td>
                    <td>${escapeHtml(levelName)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('questions','${q.id}')">ویرایش</button>
                            <button class="btn-danger" onclick="deleteDoc('questions','${q.id}')">حذف</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('questionsTable').style.display = questions.length ? 'table' : 'none';
        }

        // ------------ ITEMS CRUD ------------
        async function addItem(){
            const name = document.getElementById('itemName').value.trim();
            const type = document.getElementById('itemType').value.trim();
            const desc = document.getElementById('itemDesc').value.trim();
            if (!name) { showMessage('itemMessage','لطفاً نام آیتم را وارد کنید','error'); return; }
            try {
                await db.collection('items').add({ name, type, desc, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('itemMessage','آیتم اضافه شد','success');
                ['itemName','itemType','itemDesc'].forEach(id=>document.getElementById(id).value='');
                await loadAllData();
            } catch (err) { console.error(err); showMessage('itemMessage','خطا در افزودن آیتم','error'); }
        }

        function renderItems(){
            const tbody = document.getElementById('itemsList'); tbody.innerHTML='';
            items.forEach(it=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(it.name||'-')}</td>
                    <td>${escapeHtml(it.type||'-')}</td>
                    <td>${escapeHtml(it.desc? (it.desc.length>80? it.desc.substring(0,80)+'...':it.desc): '-')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('items','${it.id}')">ویرایش</button>
                            <button class="btn-danger" onclick="deleteDoc('items','${it.id}')">حذف</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('itemsTable').style.display = items.length ? 'table' : 'none';
        }

        // ------------ MUSIC CRUD ------------
        async function addMusic(){
            const title = document.getElementById('musicTitle').value.trim();
            const url = document.getElementById('musicUrl').value.trim();
            if (!title || !url) { showMessage('musicMessage','لطفاً عنوان و لینک را وارد کنید','error'); return; }
            try {
                await db.collection('music').add({ title, url, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('musicMessage','موزیک اضافه شد','success');
                ['musicTitle','musicUrl'].forEach(id=>document.getElementById(id).value='');
                await loadAllData();
            } catch (err){ console.error(err); showMessage('musicMessage','خطا در افزودن موزیک','error'); }
        }

        function renderMusic(){
            const tbody = document.getElementById('musicList'); tbody.innerHTML='';
            music.forEach(m=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(m.title||'-')}</td>
                    <td><a href="${escapeAttr(m.url||'#')}" target="_blank">پخش / لینک</a></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('music','${m.id}')">ویرایش</button>
                            <button class="btn-danger" onclick="deleteDoc('music','${m.id}')">حذف</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('musicTable').style.display = music.length ? 'table' : 'none';
        }

        // ------------ Delete any doc ------------
        async function deleteDoc(collection, id){
            if (!confirm('آیا از حذف این مورد اطمینان دارید؟')) return;
            try {
                await db.collection(collection).doc(id).delete();
                await loadAllData();
            } catch (err){ console.error(err); alert('خطا در حذف'); }
        }

        // ------------ Edit modal ------------
        function openEditModal(collection, id){
            const doc = getLocalDoc(collection, id);
            if (!doc) return;
            document.getElementById('modalTitle').textContent = `ویرایش ${collection}`;
            const body = document.getElementById('modalBody');
            body.innerHTML = ''; // populate form fields for each collection

            if (collection === 'players') {
                body.innerHTML = `
                    <div class="grid">
                        <label>نام</label><input id="edit_player_name" value="${escapeAttr(doc.name||'')}">
                        <label>ایمیل</label><input id="edit_player_email" value="${escapeAttr(doc.email||'')}">
                        <label>نمره</label><input id="edit_player_score" type="number" value="${escapeAttr(String(doc.score||0))}">
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('players','${id}')">ذخیره</button></div>
                    </div>
                `;
            } else if (collection === 'levels') {
                body.innerHTML = `
                    <div class="grid">
                        <label>عنوان</label><input id="edit_level_title" value="${escapeAttr(doc.title||'')}">
                        <label>سختی</label><input id="edit_level_difficulty" type="number" value="${escapeAttr(String(doc.difficulty||1))}">
                        <label>توضیحات</label><textarea id="edit_level_desc" rows="3">${escapeAttr(doc.desc||'')}</textarea>
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('levels','${id}')">ذخیره</button></div>
                    </div>
                `;
            } else if (collection === 'questions') {
                const opts = doc.options || ['','',''];
                body.innerHTML = `
                    <div class="grid">
                        <label>متن سوال</label><textarea id="edit_question_text" rows="2">${escapeAttr(doc.text||'')}</textarea>
                        <div class="grid three">
                            <div><label>گزینه ۱</label><input id="edit_q_opt1" value="${escapeAttr(opts[0]||'')}"></div>
                            <div><label>گزینه ۲</label><input id="edit_q_opt2" value="${escapeAttr(opts[1]||'')}"></div>
                            <div><label>گزینه ۳</label><input id="edit_q_opt3" value="${escapeAttr(opts[2]||'')}"></div>
                        </div>
                        <div class="grid two">
                            <div><label>پاسخ صحیح (1/2/3)</label><input id="edit_q_answer" type="number" min="1" max="3" value="${escapeAttr(String(doc.answer||1))}"></div>
                            <div><label>مرحله</label><select id="edit_q_level"></select></div>
                        </div>
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('questions','${id}')">ذخیره</button></div>
                    </div>
                `;
                populateLevelSelect('edit_q_level', doc.levelId || '');
            } else if (collection === 'items') {
                body.innerHTML = `
                    <div class="grid">
                        <label>نام</label><input id="edit_item_name" value="${escapeAttr(doc.name||'')}">
                        <label>نوع</label><input id="edit_item_type" value="${escapeAttr(doc.type||'')}">
                        <label>توضیحات</label><textarea id="edit_item_desc" rows="3">${escapeAttr(doc.desc||'')}</textarea>
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('items','${id}')">ذخیره</button></div>
                    </div>
                `;
            } else if (collection === 'music') {
                body.innerHTML = `
                    <div class="grid">
                        <label>عنوان</label><input id="edit_music_title" value="${escapeAttr(doc.title||'')}">
                        <label>لینک</label><input id="edit_music_url" value="${escapeAttr(doc.url||'')}">
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('music','${id}')">ذخیره</button></div>
                    </div>
                `;
            }

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeModal(){ document.getElementById('editModal').style.display='none'; }

        function getLocalDoc(collection,id){
            const maps = { players, levels, questions, items, music };
            return (maps[collection] || []).find(d=>d.id===id) || null;
        }

        async function updateDoc(collection, id){
            try {
                if (collection === 'players') {
                    const name = document.getElementById('edit_player_name').value.trim();
                    const email = document.getElementById('edit_player_email').value.trim();
                    const score = Number(document.getElementById('edit_player_score').value) || 0;
                    await db.collection('players').doc(id).update({ name, email, score, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'levels') {
                    const title = document.getElementById('edit_level_title').value.trim();
                    const difficulty = Number(document.getElementById('edit_level_difficulty').value) || 1;
                    const desc = document.getElementById('edit_level_desc').value.trim();
                    await db.collection('levels').doc(id).update({ title, difficulty, desc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'questions') {
                    const text = document.getElementById('edit_question_text').value.trim();
                    const opt1 = document.getElementById('edit_q_opt1').value.trim();
                    const opt2 = document.getElementById('edit_q_opt2').value.trim();
                    const opt3 = document.getElementById('edit_q_opt3').value.trim();
                    const answer = Number(document.getElementById('edit_q_answer').value) || 1;
                    const levelId = document.getElementById('edit_q_level').value || null;
                    await db.collection('questions').doc(id).update({ text, options:[opt1,opt2,opt3], answer, levelId, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'items') {
                    const name = document.getElementById('edit_item_name').value.trim();
                    const type = document.getElementById('edit_item_type').value.trim();
                    const desc = document.getElementById('edit_item_desc').value.trim();
                    await db.collection('items').doc(id).update({ name, type, desc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'music') {
                    const title = document.getElementById('edit_music_title').value.trim();
                    const url = document.getElementById('edit_music_url').value.trim();
                    await db.collection('music').doc(id).update({ title, url, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                }
                closeModal();
                await loadAllData();
            } catch (err){ console.error(err); alert('خطا در بروزرسانی'); }
        }

        // ------------ Populate level selects used in question forms ------------
        function populateLevelSelects(){
            populateLevelSelect('qLevel','');
            populateLevelSelect('edit_q_level','');
        }
        function populateLevelSelect(selectId, selectedId=''){
            const select = document.getElementById(selectId);
            if(!select) return;
            select.innerHTML = '<option value="">انتخاب کنید...</option>';
            levels.forEach(l=>{
                const opt = document.createElement('option');
                opt.value = l.id;
                opt.textContent = l.title;
                if (l.id === selectedId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        // ------------ Export / Import ------------
        function exportData(){
            const data = { players, levels, questions, items, music, exportDate: new Date().toISOString() };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'game-backup-'+Date.now()+'.json';
            a.click();
        }

        async function importData(){
            const file = document.getElementById('importFile').files[0];
            if (!file) { alert('لطفاً فایل JSON را انتخاب کنید'); return; }
            const reader = new FileReader();
            reader.onload = async function(e){
                try {
                    const data = JSON.parse(e.target.result);
                    if (!confirm('آیا می‌خواهید داده‌های فعلی را با فایل انتخابی جایگزین کنید؟ این عمل برگشت‌پذیر نیست.')) return;

                    // Optionally, you can clear existing collections first
                    // Add with new documents
                    if (Array.isArray(data.players)) {
                        for (const doc of data.players) {
                            const copy = { ...doc }; delete copy.id;
                            await db.collection('players').add(copy);
                        }
                    }
                    if (Array.isArray(data.levels)) {
                        for (const doc of data.levels) { const copy = {...doc}; delete copy.id; await db.collection('levels').add(copy); }
                    }
                    if (Array.isArray(data.questions)) {
                        for (const doc of data.questions) { const copy = {...doc}; delete copy.id; await db.collection('questions').add(copy); }
                    }
                    if (Array.isArray(data.items)) {
                        for (const doc of data.items) { const copy = {...doc}; delete copy.id; await db.collection('items').add(copy); }
                    }
                    if (Array.isArray(data.music)) {
                        for (const doc of data.music) { const copy = {...doc}; delete copy.id; await db.collection('music').add(copy); }
                    }

                    alert('داده‌ها با موفقیت وارد شدند');
                    await loadAllData();

                } catch (err) { console.error(err); alert('خطا در خواندن فایل'); }
            };
            reader.readAsText(file);
        }

        // ------------ Tabs ------------
        function switchTab(e){
            const tabEl = e.currentTarget;
            const tab = tabEl.getAttribute('data-tab');
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            tabEl.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            const target = document.getElementById(tab + 'Tab');
            if (target) target.classList.add('active');
        }

        // ------------ Utilities ------------
        function showMessage(elementId, message, type){
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = 'message ' + (type === 'success' ? 'success' : 'error');
            el.textContent = message;
            setTimeout(()=>{ el.textContent = ''; el.className = ''; }, 5000);
        }
        function escapeHtml(str = '') {
            return String(str)
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'","&#039;");
        }
        function escapeAttr(s=''){ return escapeHtml(s).replaceAll('"','&quot;'); }
    </script>
</body>
</html>

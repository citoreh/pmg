<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²ÛŒ - Ø§Ø¯Ù…ÛŒÙ†</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:'Vazirmatn',sans-serif;
            direction:rtl;
            background:linear-gradient(135deg,#0D0D0D 0%,#1A1A1A 50%,#2E3A59 100%);
            min-height:100vh;color:#F5F5F5;padding:20px;
        }
        .container{max-width:1200px;margin:0 auto}
        header{background:rgba(26,26,26,0.8);border-radius:20px;border:2px solid #D4AF37;padding:30px;text-align:center;margin-bottom:30px}
        h1{font-size:2.2rem;background:linear-gradient(45deg,#D4AF37,#B87333);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
        p.lead{color:#A0A0A0}
        .section{background:rgba(26,26,26,0.5);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid rgba(212,175,55,0.25)}
        .login-form{max-width:420px;margin:0 auto;padding:20px;background:rgba(46,58,89,0.2);border-radius:10px}
        label{display:block;margin-bottom:6px;color:#D4AF37;font-weight:700}
        input,select,textarea{width:100%;padding:10px;border-radius:8px;border:2px solid #B87333;background:rgba(26,26,26,0.8);color:#F5F5F5;margin-bottom:10px;font-family:'Vazirmatn'}
        button{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
        .btn-primary{background:linear-gradient(135deg,#D4AF37,#B87333);color:#0D0D0D}
        .btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
        .btn-edit{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:6px 12px;border-radius:8px}
        .btn-success{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#0D0D0D;padding:8px 12px;border-radius:8px}
        .tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
        .tab{padding:8px 14px;border-radius:8px;background:transparent;border:2px solid transparent;color:#A0A0A0;cursor:pointer}
        .tab.active{background:rgba(212,175,55,0.15);border-color:#D4AF37;color:#D4AF37}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .data-table{width:100%;border-collapse:collapse;margin-top:12px}
        .data-table th{background:rgba(212,175,55,0.12);color:#D4AF37;padding:8px;text-align:right;border:1px solid #B87333}
        .data-table td{padding:8px;border:1px solid rgba(184,115,51,0.2);background:rgba(26,26,26,0.2)}
        .action-buttons{display:flex;gap:8px}
        .message{padding:12px;border-radius:8px;margin-bottom:12px;text-align:center}
        .message.success{background:rgba(46,204,113,0.12);border:2px solid #2ecc71;color:#2ecc71}
        .message.error{background:rgba(231,76,60,0.12);border:2px solid #e74c3c;color:#e74c3c}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:999;justify-content:center;align-items:center}
        .modal-content{background:linear-gradient(135deg,#1A1A1A,#2E3A59);border:2px solid #D4AF37;border-radius:12px;padding:18px;width:95%;max-width:600px;max-height:85vh;overflow:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .close-modal{background:transparent;color:#e74c3c;font-size:20px;padding:4px;cursor:pointer;border:none}
        .grid{display:grid;gap:12px}
        @media (min-width:900px){ .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)} }
        @media (max-width:900px){ .tabs{overflow:auto} .data-table th,.data-table td{font-size:0.9rem} }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ® Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²ÛŒ</h1>
            <p class="lead">Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†ØŒ Ù…Ø±Ø§Ø­Ù„ØŒ Ø³ÙˆØ§Ù„Ø§ØªØŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ùˆ Ù…ÙˆØ²ÛŒÚ©</p>
        </header>

        <!-- Login -->
        <div id="loginSection" class="section">
            <div class="login-form">
                <h2 style="text-align:center;margin-bottom:14px">ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</h2>
                <div class="form-group">
                    <label for="loginEmail">Ø§ÛŒÙ…ÛŒÙ„</label>
                    <input id="loginEmail" type="email" placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="btn-primary" style="width:100%" onclick="login()">ÙˆØ±ÙˆØ¯</button>
                <div id="loginMessage"></div>
            </div>
        </div>

        <!-- Admin -->
        <div id="adminPanel" style="display:none">
            <div class="section" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
                <h2>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h2>
                <div style="display:flex;gap:8px;align-items:center">
                    <div style="text-align:center">
                        <div id="playersCount" style="font-size:1.4rem;color:#D4AF37">0</div>
                        <div style="color:#A0A0A0">Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</div>
                    </div>
                    <div style="text-align:center">
                        <div id="levelsCount" style="font-size:1.4rem;color:#D4AF37">0</div>
                        <div style="color:#A0A0A0">Ù…Ø±Ø§Ø­Ù„</div>
                    </div>
                    <button class="btn-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="players" onclick="switchTab(event)">ğŸ‘¤ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</div>
                <div class="tab" data-tab="levels" onclick="switchTab(event)">ğŸ—ºï¸ Ù…Ø±Ø§Ø­Ù„</div>
                <div class="tab" data-tab="questions" onclick="switchTab(event)">â“ Ø³ÙˆØ§Ù„Ø§Øª</div>
                <div class="tab" data-tab="items" onclick="switchTab(event)">ğŸ§© Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</div>
                <div class="tab" data-tab="music" onclick="switchTab(event)">ğŸµ Ù…ÙˆØ²ÛŒÚ©</div>
                <div class="tab" data-tab="settings" onclick="switchTab(event)">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
            </div>

            <!-- Players Tab -->
            <div id="playersTab" class="tab-content active">
                <div class="section">
                    <h3>Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†</h3>
                    <div class="grid two">
                        <div>
                            <label>Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†</label>
                            <input id="playerName" type="text" placeholder="Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†">
                        </div>
                        <div>
                            <label>Ø§ÛŒÙ…ÛŒÙ„</label>
                            <input id="playerEmail" type="email" placeholder="player@example.com">
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <label>Ù†Ù…Ø±Ù‡</label>
                        <input id="playerScore" type="number" placeholder="0">
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addPlayer()">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†</button>
                        <div id="playerMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h3>
                    <div id="playersLoading" class="message" style="background:transparent;color:#D4AF37">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                    <table id="playersTable" class="data-table" style="display:none">
                        <thead>
                            <tr><th>Ù†Ø§Ù…</th><th>Ø§ÛŒÙ…ÛŒÙ„</th><th>Ù†Ù…Ø±Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                        </thead>
                        <tbody id="playersList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Levels Tab -->
            <div id="levelsTab" class="tab-content">
                <div class="section">
                    <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø±Ø­Ù„Ù‡</h3>
                    <div class="grid two">
                        <div>
                            <label>Ø¹Ù†ÙˆØ§Ù† Ù…Ø±Ø­Ù„Ù‡</label>
                            <input id="levelTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø­Ù„Ù‡ Û±">
                        </div>
                        <div>
                            <label>Ø³Ø®ØªÛŒ (1-10)</label>
                            <input id="levelDifficulty" type="number" min="1" max="10" placeholder="1">
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                        <textarea id="levelDesc" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø­Ù„Ù‡..."></textarea>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addLevel()">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø±Ø­Ù„Ù‡</button>
                        <div id="levelMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>Ù„ÛŒØ³Øª Ù…Ø±Ø§Ø­Ù„</h3>
                    <div id="levelsLoading" class="message" style="background:transparent;color:#D4AF37">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                    <table id="levelsTable" class="data-table" style="display:none">
                        <thead><tr><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø³Ø®ØªÛŒ</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                        <tbody id="levelsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Questions Tab -->
            <div id="questionsTab" class="tab-content">
                <div class="section">
                    <h3>Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙˆØ§Ù„</h3>
                    <div>
                        <label>Ù…ØªÙ† Ø³ÙˆØ§Ù„</label>
                        <textarea id="questionText" rows="2" placeholder="Ù…ØªÙ† Ø³ÙˆØ§Ù„..."></textarea>
                    </div>
                    <div class="grid three" style="margin-top:8px">
                        <div><label>Ú¯Ø²ÛŒÙ†Ù‡ Û±</label><input id="qOpt1" type="text"></div>
                        <div><label>Ú¯Ø²ÛŒÙ†Ù‡ Û²</label><input id="qOpt2" type="text"></div>
                        <div><label>Ú¯Ø²ÛŒÙ†Ù‡ Û³</label><input id="qOpt3" type="text"></div>
                    </div>
                    <div class="grid two" style="margin-top:8px">
                        <div>
                            <label>Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ (1/2/3)</label>
                            <input id="qAnswer" type="number" min="1" max="3">
                        </div>
                        <div>
                            <label>Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                            <select id="qLevel"></select>
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addQuestion()">Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙˆØ§Ù„</button>
                        <div id="questionMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>Ù„ÛŒØ³Øª Ø³ÙˆØ§Ù„Ø§Øª</h3>
                    <div id="questionsLoading" class="message" style="background:transparent;color:#D4AF37">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                    <table id="questionsTable" class="data-table" style="display:none">
                        <thead><tr><th>Ø³ÙˆØ§Ù„</th><th>Ù¾Ø§Ø³Ø®</th><th>Ù…Ø±Ø­Ù„Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                        <tbody id="questionsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Items Tab -->
            <div id="itemsTab" class="tab-content">
                <div class="section">
                    <h3>Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…</h3>
                    <div class="grid two">
                        <div><label>Ù†Ø§Ù… Ø¢ÛŒØªÙ…</label><input id="itemName" type="text"></div>
                        <div><label>Ù†ÙˆØ¹</label><input id="itemType" type="text" placeholder="Ù…Ø«Ø§Ù„: consumable, equip"></div>
                    </div>
                    <div style="margin-top:8px">
                        <label>ØªÙˆØ¶ÛŒØ­</label>
                        <textarea id="itemDesc" rows="2"></textarea>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addItem()">Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…</button>
                        <div id="itemMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>Ù„ÛŒØ³Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</h3>
                    <div id="itemsLoading" class="message" style="background:transparent;color:#D4AF37">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                    <table id="itemsTable" class="data-table" style="display:none">
                        <thead><tr><th>Ù†Ø§Ù…</th><th>Ù†ÙˆØ¹</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                        <tbody id="itemsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Music Tab -->
            <div id="musicTab" class="tab-content">
                <div class="section">
                    <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ²ÛŒÚ©</h3>
                    <div class="grid two">
                        <div><label>Ø¹Ù†ÙˆØ§Ù†</label><input id="musicTitle" type="text"></div>
                        <div><label>Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„</label><input id="musicUrl" type="url" placeholder="https://...mp3"></div>
                    </div>
                    <div style="margin-top:8px">
                        <button class="btn-success" onclick="addMusic()">Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ²ÛŒÚ©</button>
                        <div id="musicMessage"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>Ù„ÛŒØ³Øª Ù…ÙˆØ²ÛŒÚ©</h3>
                    <div id="musicLoading" class="message" style="background:transparent;color:#D4AF37">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                    <table id="musicTable" class="data-table" style="display:none">
                        <thead><tr><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ù„ÛŒÙ†Ú©</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                        <tbody id="musicList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="section">
                    <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</h3>
                    <div style="margin-bottom:12px">
                        <label>ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„</label>
                        <p id="connectionStatus" style="color:#2ecc71">âœ“ Ù…ØªØµÙ„ Ø¨Ù‡ Firebase</p>
                    </div>
                    <div style="margin-bottom:12px">
                        <button class="btn-primary" onclick="exportData()">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (JSON)</button>
                    </div>
                    <div style="margin-bottom:12px">
                        <label>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² ÙØ§ÛŒÙ„ JSON</label>
                        <input type="file" id="importFile" accept=".json">
                        <div style="margin-top:8px">
                            <button class="btn-primary" onclick="importData()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ</button>
                        </div>
                    </div>
                    <div style="margin-top:12px">
                        <p style="color:#A0A0A0">Ù†Ú©ØªÙ‡: Ù‡Ù†Ú¯Ø§Ù… ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ØŒ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ (id) Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ø³Ù†Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">ÙˆÛŒØ±Ø§ÛŒØ´</h3>
                    <button class="close-modal" onclick="closeModal()">âœ•</button>
                </div>
                <div id="modalBody"></div>
            </div>
        </div>
    </div>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ---------- CONFIG: Replace these with your project's values ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAUUfcl7mEJ3Jw5SiA7dL_0BX4XouZ0kWs",
    authDomain: "shenoto-e26f5.firebaseapp.com",
    projectId: "shenoto-e26f5",
    storageBucket: "shenoto-e26f5.firebasestorage.app",
    messagingSenderId: "276107336693",
    appId: "1:276107336693:web:249f30844ff11b1ef99ebc",
    measurementId: "G-4L3KBNR48S"
  };

        // ---------------------------------------------------------------------

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Local caches
        let players = [], levels = [], questions = [], items = [], music = [];
        let currentUser = null;

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showAdminPanel();
                loadAllData();
            } else {
                currentUser = null;
                showLoginForm();
            }
        });

        // LOGIN / LOGOUT
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showMessage('loginMessage','Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return;
            }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('loginMessage','ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚','success');
            } catch (err) {
                console.error(err);
                showMessage('loginMessage','Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ' + (err.message||err),'error');
            }
        }

        async function logout() {
            try {
                await auth.signOut();
            } catch (err) { console.error('Logout error', err); }
        }

        function showAdminPanel(){
            document.getElementById('loginSection').style.display='none';
            document.getElementById('adminPanel').style.display='block';
        }
        function showLoginForm(){
            document.getElementById('loginSection').style.display='block';
            document.getElementById('adminPanel').style.display='none';
        }

        // LOAD all collections
        async function loadAllData(){
            try {
                // Show loading indicators
                document.getElementById('playersLoading').style.display='block';
                document.getElementById('levelsLoading').style.display='block';
                document.getElementById('questionsLoading').style.display='block';
                document.getElementById('itemsLoading').style.display='block';
                document.getElementById('musicLoading').style.display='block';

                // Fetch collections
                const [playersSnap, levelsSnap, questionsSnap, itemsSnap, musicSnap] = await Promise.all([
                    db.collection('players').get(),
                    db.collection('levels').get(),
                    db.collection('questions').get(),
                    db.collection('items').get(),
                    db.collection('music').get()
                ]);

                players = playersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                levels = levelsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                questions = questionsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                items = itemsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                music = musicSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                updateStats();
                renderPlayers();
                renderLevels();
                renderQuestions();
                renderItems();
                renderMusic();
                populateLevelSelects();

            } catch (err) {
                console.error('Error loading data', err);
                showMessage('connectionStatus','Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§','error');
            } finally {
                // hide loading texts
                ['playersLoading','levelsLoading','questionsLoading','itemsLoading','musicLoading'].forEach(id=>{
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            }
        }

        function updateStats(){
            document.getElementById('playersCount').textContent = players.length;
            document.getElementById('levelsCount').textContent = levels.length;
        }

        // ------------ PLAYERS CRUD ------------
        async function addPlayer(){
            const name = document.getElementById('playerName').value.trim();
            const email = document.getElementById('playerEmail').value.trim();
            const score = Number(document.getElementById('playerScore').value) || 0;
            if (!name) { showMessage('playerMessage','Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
            try {
                await db.collection('players').add({ name, email, score, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('playerMessage','Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯','success');
                clearPlayerForm();
                await loadAllData();
            } catch (err) {
                console.error(err); showMessage('playerMessage','Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†','error');
            }
        }
        function clearPlayerForm(){ ['playerName','playerEmail','playerScore'].forEach(id=>document.getElementById(id).value=''); }

        function renderPlayers(){
            const tbody = document.getElementById('playersList');
            tbody.innerHTML = '';
            players.forEach(p=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(p.name||'-')}</td>
                    <td>${escapeHtml(p.email||'-')}</td>
                    <td>${escapeHtml(p.score==null?0:p.score)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('players','${p.id}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button class="btn-danger" onclick="deleteDoc('players','${p.id}')">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('playersTable').style.display = players.length ? 'table' : 'none';
        }

        // ------------ LEVELS CRUD ------------
        async function addLevel(){
            const title = document.getElementById('levelTitle').value.trim();
            const difficulty = Number(document.getElementById('levelDifficulty').value) || 1;
            const desc = document.getElementById('levelDesc').value.trim();
            if (!title) { showMessage('levelMessage','Ù„Ø·ÙØ§Ù‹ Ø¹Ù†ÙˆØ§Ù† Ù…Ø±Ø­Ù„Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
            try {
                await db.collection('levels').add({ title, difficulty, desc, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('levelMessage','Ù…Ø±Ø­Ù„Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯','success');
                ['levelTitle','levelDifficulty','levelDesc'].forEach(id=>document.getElementById(id).value='');
                await loadAllData();
            } catch (err) { console.error(err); showMessage('levelMessage','Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø±Ø­Ù„Ù‡','error'); }
        }

        function renderLevels(){
            const tbody = document.getElementById('levelsList'); tbody.innerHTML='';
            levels.forEach(l=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(l.title||'-')}</td>
                    <td>${escapeHtml(l.difficulty||'-')}</td>
                    <td>${escapeHtml(l.desc? (l.desc.length>80? l.desc.substring(0,80)+'...': l.desc) : '-')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('levels','${l.id}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button class="btn-danger" onclick="deleteDoc('levels','${l.id}')">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('levelsTable').style.display = levels.length ? 'table' : 'none';
        }

        // ------------ QUESTIONS CRUD ------------
        async function addQuestion(){
            const text = document.getElementById('questionText').value.trim();
            const opt1 = document.getElementById('qOpt1').value.trim();
            const opt2 = document.getElementById('qOpt2').value.trim();
            const opt3 = document.getElementById('qOpt3').value.trim();
            const answer = Number(document.getElementById('qAnswer').value) || 1;
            const levelId = document.getElementById('qLevel').value || null;
            if (!text) { showMessage('questionMessage','Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø³ÙˆØ§Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
            try {
                await db.collection('questions').add({ text, options:[opt1,opt2,opt3], answer, levelId, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('questionMessage','Ø³ÙˆØ§Ù„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯','success');
                ['questionText','qOpt1','qOpt2','qOpt3','qAnswer'].forEach(id=>document.getElementById(id).value='');
                document.getElementById('qLevel').value='';
                await loadAllData();
            } catch (err){ console.error(err); showMessage('questionMessage','Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙˆØ§Ù„','error'); }
        }

        function renderQuestions(){
            const tbody = document.getElementById('questionsList'); tbody.innerHTML='';
            questions.forEach(q=>{
                const levelName = q.levelId ? (levels.find(l=>l.id===q.levelId)?.title || '-') : '-';
                const preview = q.text.length>100 ? q.text.substring(0,100)+'...' : q.text;
                const ansText = (q.options && q.options[q.answer-1]) ? q.options[q.answer-1] : ('Ú¯Ø²ÛŒÙ†Ù‡ ' + q.answer);
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(preview)}</td>
                    <td>${escapeHtml(ansText)}</td>
                    <td>${escapeHtml(levelName)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('questions','${q.id}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button class="btn-danger" onclick="deleteDoc('questions','${q.id}')">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('questionsTable').style.display = questions.length ? 'table' : 'none';
        }

        // ------------ ITEMS CRUD ------------
        async function addItem(){
            const name = document.getElementById('itemName').value.trim();
            const type = document.getElementById('itemType').value.trim();
            const desc = document.getElementById('itemDesc').value.trim();
            if (!name) { showMessage('itemMessage','Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¢ÛŒØªÙ… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
            try {
                await db.collection('items').add({ name, type, desc, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('itemMessage','Ø¢ÛŒØªÙ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯','success');
                ['itemName','itemType','itemDesc'].forEach(id=>document.getElementById(id).value='');
                await loadAllData();
            } catch (err) { console.error(err); showMessage('itemMessage','Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…','error'); }
        }

        function renderItems(){
            const tbody = document.getElementById('itemsList'); tbody.innerHTML='';
            items.forEach(it=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(it.name||'-')}</td>
                    <td>${escapeHtml(it.type||'-')}</td>
                    <td>${escapeHtml(it.desc? (it.desc.length>80? it.desc.substring(0,80)+'...':it.desc): '-')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('items','${it.id}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button class="btn-danger" onclick="deleteDoc('items','${it.id}')">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('itemsTable').style.display = items.length ? 'table' : 'none';
        }

        // ------------ MUSIC CRUD ------------
        async function addMusic(){
            const title = document.getElementById('musicTitle').value.trim();
            const url = document.getElementById('musicUrl').value.trim();
            if (!title || !url) { showMessage('musicMessage','Ù„Ø·ÙØ§Ù‹ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù„ÛŒÙ†Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
            try {
                await db.collection('music').add({ title, url, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showMessage('musicMessage','Ù…ÙˆØ²ÛŒÚ© Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯','success');
                ['musicTitle','musicUrl'].forEach(id=>document.getElementById(id).value='');
                await loadAllData();
            } catch (err){ console.error(err); showMessage('musicMessage','Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ²ÛŒÚ©','error'); }
        }

        function renderMusic(){
            const tbody = document.getElementById('musicList'); tbody.innerHTML='';
            music.forEach(m=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${escapeHtml(m.title||'-')}</td>
                    <td><a href="${escapeAttr(m.url||'#')}" target="_blank">Ù¾Ø®Ø´ / Ù„ÛŒÙ†Ú©</a></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="openEditModal('music','${m.id}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button class="btn-danger" onclick="deleteDoc('music','${m.id}')">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('musicTable').style.display = music.length ? 'table' : 'none';
        }

        // ------------ Delete any doc ------------
        async function deleteDoc(collection, id){
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;
            try {
                await db.collection(collection).doc(id).delete();
                await loadAllData();
            } catch (err){ console.error(err); alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù'); }
        }

        // ------------ Edit modal ------------
        function openEditModal(collection, id){
            const doc = getLocalDoc(collection, id);
            if (!doc) return;
            document.getElementById('modalTitle').textContent = `ÙˆÛŒØ±Ø§ÛŒØ´ ${collection}`;
            const body = document.getElementById('modalBody');
            body.innerHTML = ''; // populate form fields for each collection

            if (collection === 'players') {
                body.innerHTML = `
                    <div class="grid">
                        <label>Ù†Ø§Ù…</label><input id="edit_player_name" value="${escapeAttr(doc.name||'')}">
                        <label>Ø§ÛŒÙ…ÛŒÙ„</label><input id="edit_player_email" value="${escapeAttr(doc.email||'')}">
                        <label>Ù†Ù…Ø±Ù‡</label><input id="edit_player_score" type="number" value="${escapeAttr(String(doc.score||0))}">
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('players','${id}')">Ø°Ø®ÛŒØ±Ù‡</button></div>
                    </div>
                `;
            } else if (collection === 'levels') {
                body.innerHTML = `
                    <div class="grid">
                        <label>Ø¹Ù†ÙˆØ§Ù†</label><input id="edit_level_title" value="${escapeAttr(doc.title||'')}">
                        <label>Ø³Ø®ØªÛŒ</label><input id="edit_level_difficulty" type="number" value="${escapeAttr(String(doc.difficulty||1))}">
                        <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label><textarea id="edit_level_desc" rows="3">${escapeAttr(doc.desc||'')}</textarea>
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('levels','${id}')">Ø°Ø®ÛŒØ±Ù‡</button></div>
                    </div>
                `;
            } else if (collection === 'questions') {
                const opts = doc.options || ['','',''];
                body.innerHTML = `
                    <div class="grid">
                        <label>Ù…ØªÙ† Ø³ÙˆØ§Ù„</label><textarea id="edit_question_text" rows="2">${escapeAttr(doc.text||'')}</textarea>
                        <div class="grid three">
                            <div><label>Ú¯Ø²ÛŒÙ†Ù‡ Û±</label><input id="edit_q_opt1" value="${escapeAttr(opts[0]||'')}"></div>
                            <div><label>Ú¯Ø²ÛŒÙ†Ù‡ Û²</label><input id="edit_q_opt2" value="${escapeAttr(opts[1]||'')}"></div>
                            <div><label>Ú¯Ø²ÛŒÙ†Ù‡ Û³</label><input id="edit_q_opt3" value="${escapeAttr(opts[2]||'')}"></div>
                        </div>
                        <div class="grid two">
                            <div><label>Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ (1/2/3)</label><input id="edit_q_answer" type="number" min="1" max="3" value="${escapeAttr(String(doc.answer||1))}"></div>
                            <div><label>Ù…Ø±Ø­Ù„Ù‡</label><select id="edit_q_level"></select></div>
                        </div>
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('questions','${id}')">Ø°Ø®ÛŒØ±Ù‡</button></div>
                    </div>
                `;
                populateLevelSelect('edit_q_level', doc.levelId || '');
            } else if (collection === 'items') {
                body.innerHTML = `
                    <div class="grid">
                        <label>Ù†Ø§Ù…</label><input id="edit_item_name" value="${escapeAttr(doc.name||'')}">
                        <label>Ù†ÙˆØ¹</label><input id="edit_item_type" value="${escapeAttr(doc.type||'')}">
                        <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label><textarea id="edit_item_desc" rows="3">${escapeAttr(doc.desc||'')}</textarea>
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('items','${id}')">Ø°Ø®ÛŒØ±Ù‡</button></div>
                    </div>
                `;
            } else if (collection === 'music') {
                body.innerHTML = `
                    <div class="grid">
                        <label>Ø¹Ù†ÙˆØ§Ù†</label><input id="edit_music_title" value="${escapeAttr(doc.title||'')}">
                        <label>Ù„ÛŒÙ†Ú©</label><input id="edit_music_url" value="${escapeAttr(doc.url||'')}">
                        <div style="margin-top:8px"><button class="btn-success" onclick="updateDoc('music','${id}')">Ø°Ø®ÛŒØ±Ù‡</button></div>
                    </div>
                `;
            }

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeModal(){ document.getElementById('editModal').style.display='none'; }

        function getLocalDoc(collection,id){
            const maps = { players, levels, questions, items, music };
            return (maps[collection] || []).find(d=>d.id===id) || null;
        }

        async function updateDoc(collection, id){
            try {
                if (collection === 'players') {
                    const name = document.getElementById('edit_player_name').value.trim();
                    const email = document.getElementById('edit_player_email').value.trim();
                    const score = Number(document.getElementById('edit_player_score').value) || 0;
                    await db.collection('players').doc(id).update({ name, email, score, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'levels') {
                    const title = document.getElementById('edit_level_title').value.trim();
                    const difficulty = Number(document.getElementById('edit_level_difficulty').value) || 1;
                    const desc = document.getElementById('edit_level_desc').value.trim();
                    await db.collection('levels').doc(id).update({ title, difficulty, desc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'questions') {
                    const text = document.getElementById('edit_question_text').value.trim();
                    const opt1 = document.getElementById('edit_q_opt1').value.trim();
                    const opt2 = document.getElementById('edit_q_opt2').value.trim();
                    const opt3 = document.getElementById('edit_q_opt3').value.trim();
                    const answer = Number(document.getElementById('edit_q_answer').value) || 1;
                    const levelId = document.getElementById('edit_q_level').value || null;
                    await db.collection('questions').doc(id).update({ text, options:[opt1,opt2,opt3], answer, levelId, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'items') {
                    const name = document.getElementById('edit_item_name').value.trim();
                    const type = document.getElementById('edit_item_type').value.trim();
                    const desc = document.getElementById('edit_item_desc').value.trim();
                    await db.collection('items').doc(id).update({ name, type, desc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                } else if (collection === 'music') {
                    const title = document.getElementById('edit_music_title').value.trim();
                    const url = document.getElementById('edit_music_url').value.trim();
                    await db.collection('music').doc(id).update({ title, url, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                }
                closeModal();
                await loadAllData();
            } catch (err){ console.error(err); alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ'); }
        }

        // ------------ Populate level selects used in question forms ------------
        function populateLevelSelects(){
            populateLevelSelect('qLevel','');
            populateLevelSelect('edit_q_level','');
        }
        function populateLevelSelect(selectId, selectedId=''){
            const select = document.getElementById(selectId);
            if(!select) return;
            select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
            levels.forEach(l=>{
                const opt = document.createElement('option');
                opt.value = l.id;
                opt.textContent = l.title;
                if (l.id === selectedId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        // ------------ Export / Import ------------
        function exportData(){
            const data = { players, levels, questions, items, music, exportDate: new Date().toISOString() };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'game-backup-'+Date.now()+'.json';
            a.click();
        }

        async function importData(){
            const file = document.getElementById('importFile').files[0];
            if (!file) { alert('Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ JSON Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
            const reader = new FileReader();
            reader.onload = async function(e){
                try {
                    const data = JSON.parse(e.target.result);
                    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ø§ ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª.')) return;

                    // Optionally, you can clear existing collections first
                    // Add with new documents
                    if (Array.isArray(data.players)) {
                        for (const doc of data.players) {
                            const copy = { ...doc }; delete copy.id;
                            await db.collection('players').add(copy);
                        }
                    }
                    if (Array.isArray(data.levels)) {
                        for (const doc of data.levels) { const copy = {...doc}; delete copy.id; await db.collection('levels').add(copy); }
                    }
                    if (Array.isArray(data.questions)) {
                        for (const doc of data.questions) { const copy = {...doc}; delete copy.id; await db.collection('questions').add(copy); }
                    }
                    if (Array.isArray(data.items)) {
                        for (const doc of data.items) { const copy = {...doc}; delete copy.id; await db.collection('items').add(copy); }
                    }
                    if (Array.isArray(data.music)) {
                        for (const doc of data.music) { const copy = {...doc}; delete copy.id; await db.collection('music').add(copy); }
                    }

                    alert('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯');
                    await loadAllData();

                } catch (err) { console.error(err); alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„'); }
            };
            reader.readAsText(file);
        }

        // ------------ Tabs ------------
        function switchTab(e){
            const tabEl = e.currentTarget;
            const tab = tabEl.getAttribute('data-tab');
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            tabEl.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            const target = document.getElementById(tab + 'Tab');
            if (target) target.classList.add('active');
        }

        // ------------ Utilities ------------
        function showMessage(elementId, message, type){
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = 'message ' + (type === 'success' ? 'success' : 'error');
            el.textContent = message;
            setTimeout(()=>{ el.textContent = ''; el.className = ''; }, 5000);
        }
        function escapeHtml(str = '') {
            return String(str)
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'","&#039;");
        }
        function escapeAttr(s=''){ return escapeHtml(s).replaceAll('"','&quot;'); }
    </script>
</body>
</html>

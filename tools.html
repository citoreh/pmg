<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
            border-radius: 5px;
        }
        .step h3 {
            margin-top: 0;
            color: #333;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-error {
            color: #f00;
        }
        .log-success {
            color: #0f0;
        }
        .log-info {
            color: #00f;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Firebase Connection Test Tool</h1>
        
        <div class="step">
            <h3>Step 1: Enter Firebase Configuration</h3>
            <p>Paste your entire Firebase configuration object here:</p>
            <textarea id="configInput" placeholder="const firebaseConfig = {
  apiKey: &quot;...&quot;,
  authDomain: &quot;...&quot;,
  projectId: &quot;...&quot;,
  storageBucket: &quot;...&quot;,
  messagingSenderId: &quot;...&quot;,
  appId: &quot;...&quot;
};"></textarea>
            
            <button onclick="testConnection()">Test Connection</button>
            <button onclick="clearConfig()">Clear</button>
            <button onclick="useExampleConfig()">Use Example (for testing format)</button>
        </div>

        <div id="status" class="status"></div>

        <div class="step">
            <h3>Step 2: Test Results</h3>
            <div id="testResults"></div>
        </div>

        <div class="step">
            <h3>Debug Log:</h3>
            <div class="log" id="debugLog">Waiting for test...</div>
        </div>

        <div class="step">
            <h3>Common Issues & Solutions:</h3>
            <ul>
                <li><strong>CORS Error:</strong> Make sure you're running this file from a web server (not file://)</li>
                <li><strong>Invalid API Key:</strong> Check that you copied the complete configuration</li>
                <li><strong>Firestore not enabled:</strong> Go to Firebase Console → Firestore → Create Database</li>
                <li><strong>Network Error:</strong> Check your internet connection and firewall settings</li>
                <li><strong>Project not found:</strong> Verify the projectId matches your Firebase project</li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        let app = null;
        let db = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function clearConfig() {
            document.getElementById('configInput').value = '';
            document.getElementById('status').style.display = 'none';
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('debugLog').innerHTML = 'Waiting for test...';
        }

        function useExampleConfig() {
            document.getElementById('configInput').value = `const firebaseConfig = {
  apiKey: "AIzaSyExample123456789",
  authDomain: "my-project.firebaseapp.com",
  projectId: "my-project",
  storageBucket: "my-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};`;
            showStatus('⚠️ This is an example config. Replace with your actual Firebase configuration!', 'error');
        }

        async function testConnection() {
            const configText = document.getElementById('configInput').value.trim();
            
            if (!configText) {
                showStatus('Please enter your Firebase configuration', 'error');
                return;
            }

            log('Starting connection test...', 'info');
            
            try {
                // Step 1: Parse configuration
                log('Parsing configuration...', 'info');
                
                let firebaseConfig;
                
                // Try different parsing methods
                if (configText.includes('const firebaseConfig')) {
                    // Method 1: Extract object from const declaration
                    const match = configText.match(/const\s+firebaseConfig\s*=\s*({[\s\S]*?});?/);
                    if (match) {
                        firebaseConfig = eval('(' + match[1] + ')');
                        log('Config parsed using method 1 (const declaration)', 'success');
                    }
                } else if (configText.trim().startsWith('{')) {
                    // Method 2: Direct JSON object
                    firebaseConfig = JSON.parse(configText);
                    log('Config parsed using method 2 (JSON)', 'success');
                } else {
                    // Method 3: Try eval as last resort
                    firebaseConfig = eval('(' + configText + ')');
                    log('Config parsed using method 3 (eval)', 'success');
                }

                // Validate required fields
                const requiredFields = ['apiKey', 'authDomain', 'projectId', 'appId'];
                const missingFields = requiredFields.filter(field => !firebaseConfig[field]);
                
                if (missingFields.length > 0) {
                    throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
                }

                log('Configuration validated successfully', 'success');
                log(`Project ID: ${firebaseConfig.projectId}`, 'info');

                // Step 2: Initialize Firebase
                log('Initializing Firebase app...', 'info');
                
                // Clear any existing app
                if (app) {
                    await app.delete();
                }
                
                app = firebase.initializeApp(firebaseConfig);
                log('Firebase app initialized', 'success');

                // Step 3: Initialize Firestore
                log('Connecting to Firestore...', 'info');
                db = firebase.firestore();
                
                // Step 4: Test Firestore connection
                log('Testing Firestore write operation...', 'info');
                const testDoc = await db.collection('_test').add({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true,
                    createdAt: new Date().toISOString()
                });
                log(`Test document created with ID: ${testDoc.id}`, 'success');

                // Step 5: Test read operation
                log('Testing Firestore read operation...', 'info');
                const testRead = await testDoc.get();
                if (testRead.exists) {
                    log('Test document read successfully', 'success');
                    
                    // Clean up test document
                    await testDoc.delete();
                    log('Test document deleted', 'info');
                }

                // Step 6: Get collections info
                log('Checking existing collections...', 'info');
                const collections = await db.collection('artists').limit(1).get();
                const tracksCollection = await db.collection('tracks').limit(1).get();
                
                // Display results
                const resultsDiv = document.getElementById('testResults');
                resultsDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 5px; color: #155724;">
                        <h4>✅ Connection Successful!</h4>
                        <ul>
                            <li>Project ID: <code>${firebaseConfig.projectId}</code></li>
                            <li>Auth Domain: <code>${firebaseConfig.authDomain}</code></li>
                            <li>Firestore Status: <strong>Connected</strong></li>
                            <li>Artists Collection: <strong>${collections.empty ? 'Empty (0 documents)' : 'Has data'}</strong></li>
                            <li>Tracks Collection: <strong>${tracksCollection.empty ? 'Empty (0 documents)' : 'Has data'}</strong></li>
                        </ul>
                        <p><strong>Next Steps:</strong></p>
                        <ol>
                            <li>Copy this exact configuration to your migration tool</li>
                            <li>The connection is working! You can now migrate your data</li>
                        </ol>
                    </div>
                `;

                showStatus('✅ Firebase connection successful! Firestore is ready.', 'success');
                log('All tests passed! Firebase is properly configured.', 'success');

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error('Full error:', error);
                
                // Provide specific error guidance
                let errorGuidance = '';
                
                if (error.message.includes('Failed to parse')) {
                    errorGuidance = 'Configuration format is incorrect. Make sure to copy the entire config object including "const firebaseConfig = {...}"';
                } else if (error.message.includes('Missing required fields')) {
                    errorGuidance = 'Your configuration is incomplete. Make sure all fields are present.';
                } else if (error.code === 'permission-denied') {
                    errorGuidance = 'Firestore security rules are blocking access. Go to Firebase Console → Firestore → Rules and temporarily set: allow read, write: if true;';
                } else if (error.code === 'unavailable') {
                    errorGuidance = 'Cannot reach Firebase. Check your internet connection and firewall settings.';
                } else if (error.message.includes('app/invalid-api-key')) {
                    errorGuidance = 'Invalid API key. Check that you copied the correct configuration from Firebase Console.';
                } else if (error.message.includes('Cannot read properties')) {
                    errorGuidance = 'Firestore might not be enabled. Go to Firebase Console → Firestore Database → Create Database';
                }

                const resultsDiv = document.getElementById('testResults');
                resultsDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 5px; color: #721c24;">
                        <h4>❌ Connection Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        ${errorGuidance ? `<p><strong>Solution:</strong> ${errorGuidance}</p>` : ''}
                        <p><strong>Troubleshooting:</strong></p>
                        <ol>
                            <li>Check the Debug Log below for details</li>
                            <li>Verify your Firebase configuration in Firebase Console</li>
                            <li>Make sure Firestore is enabled in your Firebase project</li>
                            <li>Check browser console (F12) for additional errors</li>
                        </ol>
                    </div>
                `;

                showStatus('❌ Connection failed. See details below.', 'error');
            }
        }

        // Test on page load if config exists
        window.onload = function() {
            log('Page loaded. Ready to test Firebase connection.', 'info');
            log('Firebase SDK version: ' + firebase.SDK_VERSION, 'info');
        }
    </script>
</body>
</html>
